<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="css/styles.css" rel="stylesheet" />
    <style> 
    html,
body {
  height: 100%;
}

#page-content {
  flex: 1 0 auto;
}
.carrito{
  width: 35%;
  height: 100%;
  border-left: 1px solid #616161;
  position: fixed;
  margin-left: 65%;
  background-color: white;
  visibility:hidden;
}
.cerrarcarrito{
  margin-left: 5px;
  margin-top: 15px;
}
.ultimas{
  color: #e0d100;
    animation: pulse-animation 2s infinite;
}
@keyframes pulse-animation {
  0% {
    color: #e0d100;
  }
  50% {
    color:rgb(255, 123, 0);
  }
  100% {
    color: #e0d100;
  }
}
    </style>
</head>
<body class="d-flex flex-column"    >
<!-- Navigation-->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container px-4 px-lg-5">
                <a class="navbar-brand" href="index.html">Aplicacion carrito</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 ms-lg-4">
                        <li class="nav-item"><button class="dropdown-item" onclick="actualizar()">Todos los productos</button></li>                        
                    </ul>
                    <button class="btn btn-outline-dark" type="button" onclick="abrircarrito()">
                            <i class="bi-cart-fill me-1"></i>
                            Carrito
                            <span class="badge bg-dark text-white ms-1 rounded-pill">0</span>
                        </button>
                    <div class="navbar-nav  mb-2 mb-lg-0 ms-lg-4">
                        <button type="button" class="btn btn-outline-none" aria-current="page" data-bs-toggle="modal" data-bs-target="#modalidentificar" onclick="identificar()">Identificarse/Registrarse</a>
                    </div>
                        <div class="modal fade" id="modalidentificar" tabindex="-1" aria-labelledby="modalidentificarlabel" aria-hidden="true">
                          <div class="modal-dialog">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Usuario</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                ...
                              </div>
                              <div class="modal-footer" id="botonesidentify">
                                <button type="button" class="btn btn-primary">Identificarte</button> O <button type="button" class="btn btn-primary">Registrarse</button>
                              </div>
                            </div>
                          </div>
                        </div>
                </div>
            </div>
        </nav>
        <div id="page-content">
            <div class="container text-center">
              <div class="row justify-content-center" id="content">
                
              </div>
            </div>
        </div>
        <div class="carrito" id="carrito">
          <button type="button" class="btn-close cerrarcarrito" data-bs-dismiss="modal" aria-label="Close" onclick="cerrarcarrito()"></button><div id="total"></div>
          <hr>
          <div id="carritocontent">
          El carrito esta vacio
        </div>
        </div>

        <footer id="sticky-footer" class="flex-shrink-0 py-4 bg-dark text-white-50">
            <div class="container text-center">
              <small>Copyright &copy; Your Website</small>
            </div>
          </footer>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  var articulos=[]; 
  var carrito=[];
  if (sessionStorage.getItem("carrito")) {
    carrito = JSON.parse(sessionStorage.getItem("carrito"));
}else{
  sessionStorage.setItem("carrito",JSON.stringify(carrito));
}
console.log(carrito);


function actualizar(mostrar){$.ajax({
    type: "POST",
    dataType: "json",
    url: "ajax/ajaxarticulos.php",
    data: "",
    success: function(data) {
      if(mostrar){
      document.getElementById("content").innerHTML = "";
      }
      data.forEach(function(articulo){
        articulos[parseInt(articulo['codArticulo']  )]=articulo;
        if(mostrar){
        document.getElementById("content").innerHTML+="<div class=\"row\"><div class=\"col-md-4\" id=\"pop\"><button type=\"button\" class=\"btn\" data-bs-toggle=\"modal\" data-bs-target=\"#modal"
          +articulo['codArticulo']+
          "\"><img class=\"img-fluid rounded mb-3 mb-md-0\" src=\"img/"+articulo['codArticulo']+".png\" alt=\"\" style=\"max-height:100px\"></button></div><div class=\"col-md-8\"><h3>"+articulo['nombre']+
            "</h3>"+(parseInt(articulo['cantidad'])<=parseInt(articulo['cantidadMinima'] )?(parseInt(articulo['cantidad'])>0?"<h5 class=\"ultimas\">Ultimas unidades de este articulo</h5>":""):"")+"<h6>Precio "+(parseFloat(articulo['PVP'])*(parseFloat(articulo['IVA'])+1)).toFixed(2)+" €</h6>"+(parseInt(articulo['cantidad'])>0?"<input id=\"cantidad"+articulo['codArticulo']+"\" type=\"number\" value=\"1\" min=\"1\" max=\""+articulo['cantidad']+"\" > <button class=\"btn btn-primary\" onclick=\"añadir("+articulo['codArticulo']+")\">Añadir al carrito</button>":"<h5 style=\"color:red\">Articulo agotado</h5>")+"</div></div><div class=\"modal fade\" id=\"modal"
            +articulo['codArticulo']+"\" tabindex=\"-1\" aria-labelledby=\"modalLabel"
            +articulo['codArticulo']+"\" aria-hidden=\"true\"><div class=\"modal-dialog\"><div class=\"modal-content\"><div class=\"modal-header\"><h1 class=\"modal-title fs-5\" id=\"exampleModalLabel\">"
            +articulo['nombre']+"</h1><button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button></div><div class=\"modal-body\"><img class=\"img-fluid rounded mb-3 mb-md-0\" src=\"img/"
            +articulo['codArticulo']+".png\" alt=\"\" style=\"height:auto;width:600px\"></div><div class=\"modal-footer\"><button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cerrar</button></div></div></div></div><hr style=\"margin-top:10px\">";
            }
          });

    },
    error: function(data){
       console.log("Error");
    }
});
}





function abrircarrito(){
  document.getElementById('carrito').style.visibility="visible";
}
function cerrarcarrito(){
  document.getElementById('carrito').style.visibility="hidden";
}

function actualizar_carrito(){
  sessionStorage.setItem("carrito",JSON.stringify(carrito));
  if (carrito!=""){
  let total=0;
  for (var key in carrito){
    console.log(parseInt(carrito[key]));
    if (!isNaN(parseInt(carrito[key]))){
    let precio=(parseFloat(articulos[parseInt(key)]['PVP'])*(parseFloat(articulos[parseInt(key)]['IVA'])+1)).toFixed(2);
    let cantidad=precio*carrito[key];
    total+=cantidad;
  }
}
  document.getElementById('total').innerHTML="<hr>Total: "+total+"€";
}
}



function añadir(id){

  actualizar(false);
  console.log(articulos);
  let anadiendo=document.getElementById('cantidad'+id).value;
  let anadido=0;
  if(typeof carrito[id]!=='undefined'){
    anadido=carrito[id];
  }
if((anadido+anadiendo)<=articulos[id]['cantidad']){
  if(typeof carrito[id]==='undefined'){
    carrito[id]=parseInt(anadiendo);
  }else{
  carrito[id]+=parseInt(anadiendo);
  }
  actualizar_carrito();
  console.log(carrito);
}else{
  alert("No hay tantos articulos disponibles")
}
actualizar(true);
}



actualizar(true);
actualizar_carrito();



</script>
</html>